rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Function to check if the requesting user is the designated admin
    function isAdmin() {
      return request.auth != null &&
             request.auth.uid == "VJdxemjpYTfR3TAfAQDmZ9ucjxB2";
    }

    // Function to check if any user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }

    // Function to check if user owns the document
    function isOwner(userId) {
      return request.auth != null && request.auth.uid == userId;
    }

    /* ─────────── Collections ─────────── */

    // Rule for the 'clients' collection (client profiles)
    // Admins can read/write all client profiles.
    // Authenticated users can read/write their own profile.
    match /clients/{clientId} {
      allow read, write: if isAdmin() || isOwner(clientId);
      allow create: if isAuthenticated() && request.auth.uid == clientId;
    }

    // Rule for the 'bookings' collection
    // Admins can read/write all bookings.
    // Authenticated users can create bookings and read their own bookings.
    match /bookings/{bookingId} {
      allow read, write: if isAdmin();
      allow create: if isAuthenticated();
      allow read, update: if isAuthenticated() && 
        (resource.data.customerId == request.auth.uid || 
         resource.data.customerEmail == request.auth.token.email);
    }

    // Rule for the 'conversations' collection
    // Admins can read/write all conversations.
    // Authenticated users can read/write conversations they are part of.
    // Conversation IDs follow pattern: "{clientId}_admin"
    match /conversations/{conversationId} {
      allow read, write: if isAdmin();
      allow create, read, update: if isAuthenticated() && 
        conversationId.matches('.*' + request.auth.uid + '.*');
    }

    // Rule for the 'messages' collection
    // Admins can read/write all messages.
    // Authenticated users can create messages and read messages in their conversations.
    match /messages/{messageId} {
      allow read, write: if isAdmin();
      allow create: if isAuthenticated() && 
        request.resource.data.senderId == request.auth.uid;
      allow read: if isAuthenticated() && (
        resource.data.senderId == request.auth.uid ||
        resource.data.conversationId.matches('.*' + request.auth.uid + '.*')
      );
    }

    // Rule for the 'notifications' collection
    // Admins can read/write all notifications.
    // Authenticated users can read their own notifications.
    match /notifications/{notificationId} {
      allow read, write: if isAdmin();
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow create: if isAuthenticated();
    }

    // Rule for the 'stylists' collection
    // Admins can read/write all stylists.
    // Authenticated users can read stylists.
    match /stylists/{stylistId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }

    // Allow creating test documents for debugging
    match /test/{testId} {
      allow read, write: if isAuthenticated();
    }

    // Deny all other access by default
    match /{document=**} {
      allow read, write: if false;
    }

  }
}
